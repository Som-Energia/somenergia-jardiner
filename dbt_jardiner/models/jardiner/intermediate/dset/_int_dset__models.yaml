version: 2

models:
  - name: int_dset__last_registries
    description: >
      selecciona el ts màxim per a cada senyal i el fa servir per seleccionar la fila per a cada planta
      i senyal via un left join.
      Per disseny, només tindrà una fila per senyal_uuid i planta, la més recent.

  - name: int_plants_overview_instant
    description: >
      En aquest model ajuntem els registres mésrecients de potència instantania i irradiatió de planta amb
      la producció del dia anteriorper fer una taula resum al superset.
    columns:
      - name: ultim_registre_pot_instantanea
        description:
          Es tracta del registre més antic de tots els registres d'inversor que estem sumant per calcular la
          pot_instantantanea_planta_kw.
      - name: pot_instantantanea_planta_kw
        description: Suma de la potència activ a de tots els inversors de cada planta.

  - name: int_signal_device_relation__distinct_devices
    description: >
      Tots els devices descrits en el signal_device_relation que mapeja signal_uuid <--> device_uuid.
      Serveix per a evaluar la coherència interna dels camps desnormalitzats dels devices, és a dir,
      que un device (per uuid) no canviï de nom o aparell d'un senyal a l'altre.
    columns:
      - name: plant_uuid
        tests:
          - relationships:
              to: ref("raw_gestio_actius_plant_parameters")
              field: plant_uuid

  - name: int_dset_responses__union_view_and_materialized
    description: >
      Aquest model fa un union d'una taula materialitzada i una vista sobre la taula raw_dset_responses.
      Aquesta materialització es fa per tenir una taula més rápida amb la normalització
      de les respostes ja feta amb una hora de retard i fer només la normalització online
      per la hora més recent

    columns:
      - name: group_name
      - name: queried_at
      - name: signal_code
      - name: signal_device_type
      - name: signal_device_uuid
      - name: signal_frequency
      - name: signal_id
      - name: signal_is_virtual
      - name: signal_last_ts
      - name: signal_last_value
      - name: signal_type
      - name: signal_tz
      - name: signal_unit
      - name: signal_uuid
        tests:
          - not_null:
              config:
                store_failures: true
                tags: [dset]
      - name: signal_uuid_raw
        tests:
          - dbt_utils.not_empty_string:
              config:
                store_failures: true
                tags: [dset]
      - name: signal_value
      - name: ts
